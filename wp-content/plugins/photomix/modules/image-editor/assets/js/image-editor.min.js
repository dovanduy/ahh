photomix.editor={},function(t,e){e.Canvas=function(e,o){var a,i,n,r={};r.addMask=function(t){i[t.getId()]=t;var e=t.getFabricMask();a.add(e),s(e),a.renderAll()},r.getFabricCanvas=function(){return a},r.setLibrary=function(t){n=t};var s=function(t){fabric.loadSVGFromURL(o.icons.noPhoto,function(e,i){var n=fabric.util.groupSVGElements(e,i),r=t.left,s=t.top,c=t.width,l=t.height,d=n.width,f=n.height,m=0,h=0;void 0!==o.icons.masks&&o.icons.masks[t.maskFor]&&(o.icons.masks[t.maskFor].xOffset&&(m=o.icons.masks[t.maskFor].xOffset),o.icons.masks[t.maskFor].yOffset&&(h=o.icons.masks[t.maskFor].yOffset)),n.set({left:m||Math.round(r+c/2-d/2),top:h||Math.round(s+l/2-f/2),opacity:"0.2",hasRotatingPoint:!1,hasControls:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,hoverCursor:"auto",maskFor:t.maskFor}),t.noPhotoIcon=n,a.addToPosition(n,t.getZIndex()+1)})},c=function(){a.on("object:added",function(t){for(var e in i){var o=i[e];!1!==o.getZIndex()&&a.moveTo(o.getFabricMask(),o.getZIndex()),o.hasImage()&&!1!==o.getImageZIndex()&&a.moveTo(o.getFabricImage(),o.getImageZIndex())}})},l=function(){a.on("mouse:down",function(t){var e=t.target;if(e.photomixObject||a.deactivateAll().renderAll(),void 0!==e.maskFor){var o=e.maskFor;for(var n in i){var r=i[n];if(o===r.getImageId()){r.hasImage()||photomix.openMediaLibrary({onSelect:function(t){var e=t.sizes.full.url;r.setImage(e)}});break}}}})},d=function(){a.on("object:moving",function(t){var e=t.target;if(void 0!==e.mask&&void 0!==i[e.mask]){var o=i[e.mask].getFabricMask(),a=e.width*e.scaleX,n=e.height*e.scaleY;e.left>o.left&&e.left<o.left+20&&e.set("left",o.left),e.left+a>o.left+o.width-20&&e.left+a<o.left+o.width&&e.set("left",o.left+o.width-a),e.top>0&&e.top<20&&e.set("top",0),e.top+n>o.height-20&&e.top+n<o.height&&e.set("top",o.height-n)}})},f=function(){t("#photomix-save").on("click",function(e){e.preventDefault();var o=t(this);o.text(o.attr("data-photomix-saving"));var a={};for(var r in i){var s=i[r];a[r]=s.getDataToSave()}return t.ajax({type:"POST",url:ajaxurl,dataType:"json",data:{action:"photomix_save_image",photomix_image_id:u(),photomix_image_title:h(),photomix_image_filename:g(),photomix_image_template:p(),photomix_image_data:v(),photomix_image_masks:a,photomix_image_objects:n.getObjectsDataToSave()}}).done(function(t){"success"===t.status?window.location=t.args.edit_url.replace(/&amp;/g,"&"):alert(t.message)}),!1})},m=function(){t("#photomix-download").on("click",function(){var t=g();this.href=v(),this.download=t,this.click()})},h=function(){var e=t.trim(t("#photomix-title").val());return e||(e="Photomix image"),e},g=function(){var t=h();return t=t.toLowerCase().replace(/\s/g,"-"),t+=".png"},u=function(){return photomixConfig.imageId},p=function(){return photomixConfig.template},v=function(){a.deactivateAll().renderAll();var t=a.width,o=a.height,i=photomixConfig.export.max_width,n=document.createElement("canvas"),r=n.getContext("2d"),s=i,c=o*(i/t);n.width=s,n.height=c;var l=document.getElementById(e);return r.drawImage(l,0,0,s,c),n.toDataURL("image/png",.92)};return o=t.extend({preserveObjectStacking:!0},o),a=new fabric.Canvas(e,o),fabric.Object.prototype.getZIndex=function(){return this.canvas.getObjects().indexOf(this)},fabric.Canvas.prototype.addAndKeepStack=function(t){this.add(t),a.bringToFront(n.getObjectOnCanvas())},fabric.Canvas.prototype.addToPosition=function(t,e){for(this.add(t);t.getZIndex()>e;)this.sendBackwards(t)},a.width,a.height,i={},l(),c(),d(),f(),m(),r},e.Mask=function(e,o,a){var i,n,r,s,c,l,d,f={},m={originX:"left",originY:"top",left:0,top:0,strokeWidth:0,selectable:!1,icons:{}},h=null,g=1;f.getId=function(){return e},f.getFabricCanvas=function(){return a},f.getFabricMask=function(){return i},f.getZIndex=function(){return void 0!==o.zIndex&&parseInt(o.zIndex,10)},f.getImageId=function(){return o.image.id},f.getImageZIndex=function(){return void 0!==o.image.zIndex&&parseInt(o.image.zIndex,10)},f.hasImage=function(){return null!==h},f.getFabricImage=function(){return h},f.setImage=function(t){u(),n.src=t},f.getImage=function(){return f.hasImage()?n.src:""},f.getImageLeftPos=function(){return f.hasImage()?h.left:""},f.getImageTopPos=function(){return f.hasImage()?h.top:""},f.getFlip=function(){return!!f.hasImage()&&h.flipX},f.getScale=function(){return f.hasImage()?g:1},f.getDataToSave=function(){return{url:f.getImage(),left:f.getImageLeftPos(),top:f.getImageTopPos(),flip:f.getFlip()?"yes":"no",scale:f.getScale()}};var u=function(){if(!r){r=new fabric.Text("Loading. Please wait...",{fontSize:30});var t=parseInt((a.width-r.width)/2,10),e=parseInt((a.height-r.height)/2,10);r.left=t,r.top=e}a.add(r)},p=function(){r&&a.remove(r)},v=function(){void 0!==o.polygonPoints?(i=new fabric.Polygon(o.polygonPoints,o)).set({maskFor:o.image.id}):(i=new fabric.Rect(o)).set({maskFor:o.image.id})},x=function(){(n=new Image).onload=function(){var e=o.image.size,r=f.getImageScaleFactor(n,i,e);s={left:i.left,top:i.top,width:n.width,height:n.height,scaleX:r,scaleY:r,flipX:!1,hasRotatingPoint:!1,hasControls:!1,hasBorders:!1,perPixelTargetFind:!0,targetFindTolerance:4,clipName:f.getImageId(),mask:f.getId(),clipTo:function(t){return _.bind(O,h)(t)}},o.image.fabricConfig&&(s=t.extend(s,o.image.fabricConfig)),h=new fabric.Image(n,s),a.addAndKeepStack(h),i.noPhotoIcon&&i.noPhotoIcon.set("opacity","0"),o.image.onAdded&&o.image.onAdded(h,f),o.image.flip&&"yes"===o.image.flip&&k(),o.image.scale&&C(o.image.scale),(o.image.left||o.image.top)&&w(o.image.left,o.image.top),c.removeClass("photomix-image-actions-disabled"),p()},o.image.url&&f.setImage(o.image.url)},I=function(){c=t(".photomix-image-actions.photomix-image-"+f.getImageId())},b=function(){c.find(".photomix-flip-image").on("click",function(t){t.preventDefault(),k()})},k=function(){h.flipX=!h.flipX,o.image.onFlipped&&o.image.onFlipped(h,f),a.renderAll()},y=function(){c.find(".photomix-scale").each(function(){var e=t(this).find(".photomix-scale-value");t(this).find(".photomix-scale-slider").slider({min:.5,step:.01,max:5,value:1,slide:function(t,e){C(e.value)}}),e.on("change",function(){C(t(this).val())})})},C=function(t){if(g=t,c.find(".photomix-scale-value").val(g),l||(l=h.scaleX),d||(d=h.scaleY),h){var e=Math.round(h.width*h.scaleX/2),o=Math.round(h.height*h.scaleY/2);h.scaleX=l*g,h.scaleY=d*g;var i=Math.round(h.width*h.scaleX/2),n=Math.round(h.height*h.scaleY/2);h.left-=i-e,h.top-=n-o,a.renderAll()}},w=function(t,e){h.left=parseInt(t,10),h.top=parseInt(e,10),a.renderAll()},j=function(){c.find(".photomix-reset-image").on("click",function(t){t.preventDefault(),F()})},F=function(){h.set(s);var t=c.find(".photomix-scale-value"),e=c.find(".photomix-scale-slider");t.val(1),e.slider("value",1),a.renderAll()},P=function(){c.find(".photomix-remove-image").on("click",function(t){t.preventDefault(),M()})},M=function(){F(),o.image.onRemove&&o.image.onRemove(h,f),a.remove(h),h=null,i.noPhotoIcon&&i.noPhotoIcon.set("opacity","0.2"),a.renderAll(),c.addClass("photomix-image-actions-disabled")},S=function(t){return _.findWhere(a.getObjects(),{maskFor:t})},T=function(t){return t*(Math.PI/180)},O=function(t){var e=this.flipX?-1:1;this.setCoords();var o=S(this.clipName),a=e*(1/this.scaleX),i=1/this.scaleY;t.save();var n=e*(-this.width/2)+o.strokeWidth,r=-this.height/2+o.strokeWidth;if(t.translate(n,r),t.rotate(T(-1*this.angle)),t.scale(a,i),t.beginPath(),o instanceof fabric.Polygon){var s=[];for(var c in o.points)s.push({x:o.left+o.points[c].x-this.oCoords.tl.x,y:o.top+o.points[c].y-this.oCoords.tl.y});for(t.moveTo(s[0].x,s[0].y),c=1;c<s.length;++c)t.lineTo(s[c].x,s[c].y);t.lineTo(s[0].x,s[0].y)}else t.rect(o.left-this.oCoords.tl.x,o.top-this.oCoords.tl.y,o.width,o.height);t.closePath(),t.restore()};return f.getImageScaleFactor=function(t,e,o){o=o||"cover";var a=t.width,i=t.height,n=1,r=e.width/a,s=e.height/i;return"cover"===o&&(n=Math.max(r,s)),"contain"===o&&(n=Math.min(r,s)),n},o=t.extend(m,o),v(),x(),I(),b(),y(),j(),P(),f},e.Library=function(e,o,a){var i,n,r,s,c,l,d,f={};f.getObjectOnCanvas=function(){return s},f.hasImage=function(){return null!==l},f.setImage=function(t,e){c.src=t,c.objectId=e},f.getImage=function(){return f.hasImage()?c.src:""},f.getObjectsDataToSave=function(){var t={};return s&&(t[s.photomixId]={url:f.getImage(),left:l.left,top:l.top,angle:s.angle,scaleX:s.scaleX,scaleY:s.scaleY}),t};var m=function(){i.find(".photomix-library-tab").on("click",function(e){e.preventDefault();var o=t(this);i.find(".photomix-library-tab-current").removeClass("photomix-library-tab-current"),o.addClass("photomix-library-tab-current"),i.find(".photomix-library-panel-current").removeClass("photomix-library-panel-current"),i.find(".photomix-library-panel").eq(o.index()).addClass("photomix-library-panel-current")})},h=function(){(c=new Image).onload=function(){var t=a.color;d={photomixId:c.objectId,angle:0,left:Math.round(r.width/2-c.width/2),top:Math.round(r.height/2-c.height/2),cornerColor:a.cornerColor,transparentCorners:!1,flipX:!1,hasRotatingPoint:!0,hasControls:!0,hasBorders:!1,photomixObject:!0},fabric.loadSVGFromURL(c.src,function(e,o){if((l=fabric.util.groupSVGElements(e,o)).set(d),e&&e[c.objectId]&&(l.angle=e[c.objectId].angle,l.left=parseInt(e[c.objectId].left,10),l.top=parseInt(e[c.objectId].top,10),l.scaleX=e[c.objectId].scaleX,l.scaleY=e[c.objectId].scaleY),l.isSameColor&&l.isSameColor()||!l.paths)l.setFill(t);else if(l.paths)for(var a=0;a<l.paths.length;a++)l.paths[a].setFill(t);s=l,r.addAndKeepStack(l),r.moveTo(l,999),l.on("selected",function(){p()}),l.on("deselected",function(){v()}),r.setActiveObject(l)})}},g=function(){i.find(".photomix-library-panel .photomix-item a").on("click",function(e){if(e.preventDefault(),!s){var o=t(this);if(o.parents(".photomix-library-panel-current").length){var a=o.find("img"),i=o.attr("data-photomix-object-id");f.setImage(a.attr("src"),i)}}})},u=function(){n.find(".photomix-remove-object").on("click",function(t){if(t.preventDefault(),s){var e=r.getActiveObject();e&&s.photomixId===e.photomixId&&(r.remove(s),s=null,r.renderAll(),v())}})},p=function(){n.removeClass("photomix-object-not-selected"),n.find(".photomix-active-object-id").text(s.photomixId)},v=function(){n.addClass("photomix-object-not-selected"),n.find(".photomix-active-object-id").text("")};return function(){if(!(i=t(".photomix-library")).length)return!1;n=i.find(".photomix-library-active-object"),r=e.getFabricCanvas(),e.setLibrary(f),h(),m(),g(),u();for(var a in o)f.setImage(o[a].url,a);return f}()}}(jQuery,photomix.editor),function(t,e){"use strict";var o;e.load=function(t){var a=window.photomixEditorConfig,i=void 0!==a.canvas?a.canvas:{};o=e.Canvas(t,i);for(var n in a.masks){var r=a.masks[n];o.addMask(e.Mask(n,r,o.getFabricCanvas()))}i.shapes.cornerColor=i.backgroundColor,e.Library(o,i.objects,i.shapes)},t(document).ready(function(){t("#photomix-canvas").length>0&&photomix.editor.load("photomix-canvas")})}(jQuery,photomix.editor);